<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>confession</title>
  <meta name="google-site-verification" content="oxuIReH2Qv-7kGjuGUKYYkPMarR7TUUYBImaCIga6xQ" />
  <meta name="msvalidate.01" content="B1C0795DB5B97BEEFD7A34CB18580A64" />
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ccircle cx='8' cy='8' r='6' fill='%23D4A437'/%3E%3C/svg%3E">
</head>
<body>
  <a href="index.html" class="site-name">confession box<span>.</span></a>
  <a href="submit.html" class="submit-corner">submit a confession</a>

  <div class="container">
    <div id="confessionDisplay" class="confession-card">
      Loading...
    </div>
    <a href="read.html" class="btn-secondary">another</a>
  </div>

  <script>
    const STORAGE_KEY = 'confessionBoxSeenIds';
    const API_BASE = 'https://confession-box-worker.aabed-10.workers.dev';

    function getSeenIds() {
      try {
        const stored = sessionStorage.getItem(STORAGE_KEY);
        return new Set(stored ? JSON.parse(stored) : []);
      } catch (e) {
        console.warn('Failed to parse sessionStorage, resetting');
        sessionStorage.removeItem(STORAGE_KEY);
        return new Set();
      }
    }

    function addSeenId(id) {
      if (!id) return;
      try {
        const seen = getSeenIds();
        seen.add(id);
        sessionStorage.setItem(STORAGE_KEY, JSON.stringify([...seen]));
      } catch (e) {
        console.warn('Failed to save to sessionStorage');
      }
    }

    async function fetchRandomConfession() {
      const seenIds = getSeenIds();
      const seenArray = Array.from(seenIds);

      const res = await fetch(`${API_BASE}/api/random`, {
        headers: { 'X-Seen-Ids': seenArray.join(',') }
      });

      if (!res.ok) throw new Error(`Server error: ${res.status}`);
      return await res.json();
    }

    (async function loadConfession() {
      const confessionEl = document.getElementById('confessionDisplay');
      if (!confessionEl) return;

      try {
        const data = await fetchRandomConfession();
        const seenIds = getSeenIds();

        if (data.id && seenIds.has(data.id)) {
          confessionEl.innerText = 'ðŸ’› You have read every confession. Check back later for more, or submit your own.';
        } else {
          confessionEl.innerText = data.confession || 'No confession text.';
          if (data.id) addSeenId(data.id);
        }
      } catch (err) {
        console.error('Failed to load confession:', err);
        confessionEl.innerText = 'Something went wrong. Refresh the page.';
      }
    })();
  </script>

  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "bb089efcb4b44ed7ae0d0e0fea883f25"}'></script>

  <div style="margin-top: 40px; text-align: center; font-size: 0.7rem; opacity: 0.8;">
    <a href="https://ko-fi.com/confessionbox" target="_blank" class="footer-link">â˜• support</a>
  </div>
</body>
</html>