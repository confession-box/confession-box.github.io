<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>submit a confession</title>
  <!-- Google Site Verification -->
  <meta name="google-site-verification" content="oxuIReH2Qv-7kGjuGUKYYkPMarR7TUUYBImaCIga6xQ" />
  <!-- Bing Site Verification -->
  <meta name="msvalidate.01" content="B1C0795DB5B97BEEFD7A34CB18580A64" />
  <link rel="stylesheet" href="style.css">
  <!-- Favicon ‚Äì gold dot -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ccircle cx='8' cy='8' r='6' fill='%23D4A437'/%3E%3C/svg%3E">
</head>
<body>
  <a href="index.html" class="site-name">confession box<span>.</span></a>

  <div class="container">
    <textarea id="confessionInput" placeholder="write what you need to say..."></textarea>
    <button id="submitBtn" class="submit-btn">send</button>
    <div id="message" style="margin-top: 20px; font-size: 0.9rem;"></div>

    <a href="index.html" class="back-link">‚Üê home</a>
  </div>

  <script>
    const API_BASE = 'https://confession-box-worker.aabed-10.workers.dev';
    const BLOCKED_WORDS = [
      'cock', 'dick', 'nigger', 'cunt', 'whore', 'slut',
      'rape', 'kill', 'bomb', 'terrorist', 'faggot'
    ];

    function findBlockedWord(text) {
      const lower = text.toLowerCase();
      for (let word of BLOCKED_WORDS) {
        if (lower.includes(word)) return word;
      }
      return null;
    }

    function highlightBlockedWord(textarea, blockedWord) {
      const text = textarea.value;
      const lower = text.toLowerCase();
      const index = lower.indexOf(blockedWord);
      if (index !== -1) {
        textarea.focus();
        textarea.setSelectionRange(index, index + blockedWord.length);
        textarea.style.backgroundColor = '#ffe6e6';
      }
    }

    function removeHighlight() {
      const textarea = document.getElementById('confessionInput');
      if (textarea) textarea.style.backgroundColor = '';
    }

    document.getElementById('submitBtn').addEventListener('click', async () => {
      const textarea = document.getElementById('confessionInput');
      const text = textarea.value.trim();
      removeHighlight();
      const messageEl = document.getElementById('message');

      if (!text) {
        messageEl.innerText = 'empty confessions mean nothing.';
        return;
      }

      const blocked = findBlockedWord(text);
      if (blocked) {
        highlightBlockedWord(textarea, blocked);
        messageEl.innerText = `Blocked word: "${blocked}" ‚Äì please remove it.`;
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/confessions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ confession: text })
        });

        const contentType = res.headers.get('content-type');
        let data;
        if (contentType && contentType.includes('application/json')) {
          data = await res.json();
        } else {
          const textResponse = await res.text();
          console.error('Non-JSON response:', textResponse);
          messageEl.innerText = 'Server error ‚Äì not JSON. Check console.';
          return;
        }

        if (res.ok) {
          messageEl.innerText = '‚úì confession received.';
          textarea.value = '';
          removeHighlight();
        } else {
          // ---------- FRIENDLY 429 MESSAGE ----------
          if (res.status === 429) {
            messageEl.innerText = 'üíõ Too many confessions today! Try again tomorrow. (Limit is 1,000 per day)';
          } else {
            messageEl.innerText = data.error || 'error ‚Äì try again.';
          }
        }
      } catch (err) {
        console.error('Network or parse error:', err);
        messageEl.innerText = 'Network error ‚Äì check console.';
      }
    });

    document.getElementById('confessionInput').addEventListener('input', removeHighlight);
  </script>

  <!-- Cloudflare Web Analytics -->
  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "bb089efcb4b44ed7ae0d0e0fea883f25"}'></script>
  <!-- End Cloudflare Web Analytics -->
</body>
</html>